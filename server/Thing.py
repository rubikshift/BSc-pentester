import time
import paho.mqtt.client as mqtt
import requests
import json

def on_message(self,userdata,message):
    print("recive message=",str(message.payload.decode("utf-8")))
    if str(message.payload.decode("utf-8")) == '[{"name":"attack_name","data":"3100"}]':
        self.Send('[{"name":"receive","data":"0000"}]')

class Thing(mqtt.Client):
    def __init__(self,external_id, external_key,authorization_url,adrres):
        super(Thing, self).__init__()
        self.LoadConfig(external_id, external_key,authorization_url,adrres)
        self.username_pw_set( self.id , self.key)
        self.on_message=on_message
        self.connect(self.broker_address)
        
    def Start(self):
        self.loop_start()
        self.subscribe(topic = "channels/" + self.channel_sub_id + "/messages")
       
        
    def End(self):
        self.disconnect()
        self.loop_stop()
    
    def LoadConfig(self,external_id, external_key,authorization_url, adrres):
        PARAMS = '{"externalId": '+external_id+',"externalKey": '+external_key+'}'
        headers = {'content-type': 'application/json'}
        
        result = requests.post(url = authorization_url, data = PARAMS, headers=headers)
        data = result.json()
        
        self.broker_address = adrres 
        self.id = data.get("thing_id") 
        self.key = data.get("thing_key") 
        self.channel_sub_id = data.get("channel_sub_id") 
        self.channel_pub_id = data.get("channel_pub_id") 
        
    def Send(self,payload):
        self.publish("channels/" + self.channel_pub_id + "/messages" , payload)


