import time
import paho.mqtt.client as mqtt

def on_message(self,userdata,message):
    print("recive message=",str(message.payload.decode("utf-8")))
    if str(message.payload.decode("utf-8")) == '[{"name":"attack_name","data":"3100"}]':
        self.Send('[{"name":"receive","data":"0000"}]')

class Thing(mqtt.Client):
    def __init__(self,external_id, external_key,url, adrres , thingId , thingKey, chan_sub_id , chan_pub_id):
        super(Thing, self).__init__()
        self.LoadConfig(adrres , thingId , thingKey, chan_sub_id , chan_pub_id)
        self.username_pw_set( self.id , self.key)
        self.on_message=on_message
        self.connect(self.broker_address)
        
    def Start(self):
        self.loop_start()
        self.subscribe(topic = "channels/" + self.channel_sub_id + "/messages")
       
        
    def End(self):
        self.disconnect()
        self.loop_stop()
    
    def LoadConfig(self,adrres , thingId , thingKey, chan_sub_id , chan_pub_id):
        self.broker_address = adrres 
        self.id = thingId 
        self.key = thingKey 
        self.channel_sub_id = chan_sub_id 
        self.channel_pub_id = chan_pub_id 
        
    def Send(self,payload):
        self.publish("channels/" + self.channel_pub_id + "/messages" , payload)


