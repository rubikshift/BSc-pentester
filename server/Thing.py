import time
import json
import requests
from paho.mqtt.client import Client


class Thing(Client):
    def __init__(self, external_id, external_key, authorization_url, addres, application):
        super(Thing, self).__init__()
        self.LoadConfig(external_id, external_key, authorization_url, addres)
        self.username_pw_set(self.id, self.key)
        self.connect(self.broker_address)
        self.app = application

    def Start(self):
        self.loop_start()
        self.subscribe(topic="channels/" + self.channel_sub_id + "/messages")

    def End(self):
        self.disconnect()
        self.loop_stop()

    def LoadConfig(self, external_id, external_key, authorization_url, addres):
        PARAMS = '{"externalId": ' + external_id + \
            ',"externalKey": ' + external_key + '}'
        headers = {'content-type': 'application/json'}

        result = requests.post(url=authorization_url,
                               data=PARAMS, headers=headers)
        data = result.json()
        self.externalId = external_id
        self.broker_address = addres
        self.id = data.get("thing_id")
        self.key = data.get("thing_key")
        self.channel_sub_id = data.get("channel_sub_id")
        self.channel_pub_id = data.get("channel_pub_id")

    def Send(self, payload):
        payload = '{"externalId": ' + self.externalId + \
            ', "attackData": "' + payload + '"}'
        self.publish("channels/" + self.channel_pub_id + "/messages", payload)

    def OnConnected(self):
        while True:
            self.publish("channels/" + self.channel_pub_id +
                         "/messages", "RpiCommunication:" + self.externalId)
            time.sleep(1)
