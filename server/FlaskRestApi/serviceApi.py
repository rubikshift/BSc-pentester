import time
import json
from datetime import datetime
from datetime import timedelta
import paho.mqtt.client as mqtt
from api.Database import Database

class ActiveRpiModel():
    def __init__(self, message):
        self.date = datetime.now()
        self.message = message

def checkIfExist(message , list):
    for element in list:
        if element.message == message:
            return False
    return True

def updateDate(message):
    for i, element in enumerate(ActiveRpi):
        if element.message == message:
            print("new date")
            ActiveRpi[i].date = datetime.now()

ActiveRpi = []
def on_message(client, userdata, message):
    if "RpiCommunication:" in message.payload.decode("utf-8"):
        date = datetime.now()
        actRpi = ActiveRpiModel(message.payload.decode("utf-8"))
        if checkIfExist(message.payload.decode("utf-8") , ActiveRpi):
            print("add new rpi" + message.payload.decode("utf-8"))
            ActiveRpi.append(actRpi)
        else:
            updateDate(message.payload.decode("utf-8"))
        for rpi in ActiveRpi:
            if rpi.date < date - timedelta(seconds=4):
                ActiveRpi.remove(rpi)
    else:
        db = Database()
        parseMessage = json.loads(message.payload.decode("utf-8"))
        print(parseMessage["externalId"])
        data = {
                    "payload": parseMessage["attackData"],
                    "externalId": parseMessage["externalId"]
                    }
        db.AddPayload(data)
        print("receive message=", str(message.payload.decode("utf-8")))


def startSub():
    id = "ce5f2a5c-405f-47e0-8550-301468fcc8ff"
    key = "bf83db8f-0300-44d7-a6e5-8a7f24451609"
    broker_address = "165.22.121.233"
    while True:
        db = Database()
        channels = db.GetAllPubChannels()
        client = mqtt.Client()
        client.on_message = on_message
        client.username_pw_set(id, key)
        client.connect(broker_address)
        client.loop_start()
        for channel in channels:
            client.subscribe(topic="channels/" + channel["channel_pub_id"] + "/messages")
        count=0
        while count < 30:
            count=count+1
            time.sleep(1)
        print("disconnect")
        client.disconnect()
        client.loop_stop()


def executeSendOperation(channels, info):
    id = "ce5f2a5c-405f-47e0-8550-301468fcc8ff"
    key = "bf83db8f-0300-44d7-a6e5-8a7f24451609"
    broker_address = "165.22.121.233"

    client = mqtt.Client()
    client.username_pw_set(id, key)
    client.connect(broker_address)
    for channel in channels:
        client.publish(topic="channels/" + channel["channel_sub_id"] + "/messages", payload=info)
        time.sleep(0.01)


def startPubToAllRpi(info):
    db = Database()
    channels = db.GetAllSubChannels()
    executeSendOperation(channels, info)


def startPubToChosenRpi(info, externalId):
    db = Database()
    if db.IsExist(externalId):
        data = db.GetRpi(externalId)
        channel = data["channel_sub_id"]
        channels = [channel]
        executeSendOperation(channels, info)

def getAllActiveRpi():
    date = datetime.now()
    for rpi in ActiveRpi:
        if rpi.date < date - timedelta(seconds=4):
            ActiveRpi.remove(rpi)
    return ActiveRpi

