import time
import paho.mqtt.client as mqtt
from api.Database import Database

def on_message(client,userdata,message):
    print("recive message=",str(message.payload.decode("utf-8")))

def startSub():
	id = "ce5f2a5c-405f-47e0-8550-301468fcc8ff"
	key = "bf83db8f-0300-44d7-a6e5-8a7f24451609"
	broker_address = "165.22.121.233"

	db = Database()
	channels=db.GetAllPubChannels()

	client = mqtt.Client()
	client.on_message=on_message
	client.username_pw_set(id, key)
	client.connect(broker_address)
	client.loop_start()
	for channel in channels:
		print(channel["channel_pub_id"])
		client.subscribe(topic = "channels/" + channel["channel_pub_id"] + "/messages")
	time.sleep(18)
	print("disconnect")
	client.disconnect()
	client.loop_stop()

def startPubToAllRpi(info):
	id = "ce5f2a5c-405f-47e0-8550-301468fcc8ff"
        key = "bf83db8f-0300-44d7-a6e5-8a7f24451609"
        broker_address = "165.22.121.233"

        db = Database()
        channels=db.GetAllSubChannels()

	client = mqtt.Client()
	client.username_pw_set(id, key)
	client.connect(broker_address)
	for channel in channels:
		client.publish(topic = "channels/" + channel["channel_sub_id"] + "/messages" , payload=info)
		time.sleep(0.01)
