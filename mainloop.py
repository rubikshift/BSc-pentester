#!/usr/bin/env python3

from server.Thing import Thing
from lib.systemUtils import log
from lib.usb.ether import Ether
from lib import systemUtils as utils
from lib.usb.keyboard import Keyboard
from config import MainApp
import ast
import threading
import uuid


def on_message(thing, userdata, message):
    log("on message")
    msg = str(message.payload.decode("utf-8"))
    log("message acquired: " + msg)
    if msg == 'communication':
        thing.Send(thing.externalId)
    else:
        log("no-communication")
        data = ast.literal_eval(msg)
        # log('dict: ' + data['muffin'])
        log(data)
        log(data['deviceType'])
        thing.app.launch(data)


def main():
    app = MainApp()
    test = uuid.uuid4()
    thing = Thing(f'"{test}"', f'"{test}"',
                  "http://165.22.121.233:8888/api/authorization/", "165.22.121.233", app)
    thing.on_message = on_message

    thing.Start()

    thr = threading.Thread(target=thing.OnConnected)
    thr.start()
    thing.Send("hmmm.py")

    while True:
        pass


if __name__ == "__main__":
    main()
