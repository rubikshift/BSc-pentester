from server.Thing import Thing
from lib.usb.ether import Ether
from lib import systemUtils as utils
from lib.usb.keyboard import Keyboard
from config import MainApp
import ast
import threading


def on_message(thing, userdata, message):
    print("on message")
    msg = str(message.payload.decode("utf-8"))
    print("message acquired: " + msg)
    if msg == 'communication':
        thing.Send(thing.externalId)
    else:
        print("no-communication")
        data = ast.literal_eval(msg)
        # print('dict: ' + data['muffin'])
        print(data)
        print(data['deviceType'])
        thing.app.launch(data)


def main():
    app = MainApp()
    thing = Thing('"4567"', '"4567"',
                  "http://165.22.121.233:8888/api/authorization/", "165.22.121.233", app)
    thing.on_message = on_message

    thing.Start()

    thr = threading.Thread(target=thing.OnConnected)
    thr.start()
    thing.Send("abcs.py")

    while True:
        pass


if __name__ == "__main__":
    main()
