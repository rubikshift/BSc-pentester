import os
from subprocess import Popen, PIPE
from lib import systemUtils as utils


class Device:
    _CONFIG_FS_PATH = "/sys/kernel/config/usb_gadget/"

    def __init__(self, name, idVendor, idProduct,
                 serial, manufacturer, product, *args, **kwargs):
        utils.activateModules("dwc2", "libcomposite")
        self._path = path = os.path.join(self._CONFIG_FS_PATH, name)
        os.makedirs(path, exist_ok=True)

        with open(os.path.join(path, "idVendor"), 'w') as file:
            file.write(idVendor)

        with open(os.path.join(path, "idProduct"), 'w') as file:
            file.write(idProduct)
        
        with open(os.path.join(path, "bcdDevice"), 'w') as file:
            file.write("0x0100")
        
        with open(os.path.join(path, "bcdUSB"), 'w') as file:
            file.write("0x0200")
        
        path = os.path.join(self._path, "strings", "0x409")
        os.makedirs(path, exist_ok=True)
        with open(os.path.join(path, "serialnumber"), 'w') as file:
            file.write(serial)
        
        with open(os.path.join(path, "manufacturer"), 'w') as file:
            file.write(manufacturer)
        
        with open(os.path.join(path, "product"), 'w') as file:
            file.write(product)
        
        path = os.path.join(self._path, "configs", "c.1")
        os.makedirs(path, exist_ok=True)
        with open(os.path.join(path, "MaxPower"), 'w') as file:
            file.write("250")

        path = os.path.join(path, "strings", "0x409")
        os.makedirs(path, exist_ok=True)
        #with open(os.path.join(path, "configuration"), 'w') as file:
        #    # tego nie czaję - cały internet tak ma, ale klawiatura dziala bez tego
        #    file.write("Config 1: ECM network")

        self._customConfig(*args, *kwargs)

        path = self._path
        with open(os.path.join(path, "UDC"), 'w') as file:
            file.write('\n'.join(os.listdir("/sys/class/udc")))

    def _customConfig(self, *args, **kwargs):
        pass

    def executePayload(self, *args, **kwargs):
        pass
