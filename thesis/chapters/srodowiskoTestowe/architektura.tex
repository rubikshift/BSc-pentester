\subsection[Architektura środowiska testowego]{Architektura środowiska testowego}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{kp01}
    \caption{Schemat przedstawiający podstawowe zależności w środowisku testowym } % role Środowiska testowego w dedykowanym systemie
    \label{fig:iotarch}
\end{figure} 
Środowisko testowe składa się z kilku komponentów programowych: aplikacji sterującej, platformy Mainflux, bazy danych, dashboardu oraz klienta komunikacji. Wszystkie wymienione elementy za wyjątkiem klienta komunikacji znajdują się na jednej maszynie.
Aplikacja sterująca to oprogramowanie, które ma kilka zadań do spełnienia, pierwszym jest zapewnienie autoryzacji platformy wykonującej. Każda platforma jest skonfigurowana w Mainfluxie jako \textit{rzecz} (rozdział~\ref{subsection:wp}). Posiada swój zewnętrzny identyfikator oraz klucz, w momencie, gdy platforma wykonująca chce otrzymać swoje dane (tzn. klucz rzeczy, identyfikator rzeczy oraz 2 przypisane kanały) wysyła żądanie HTTP na serwer z zewnętrznym identyfikatorem oraz kluczem. Platforma wykonująca potrzebuje 2. kanałów, ponieważ na jednym będzie wysyłała wiadomości, a na drugim odbierała. Aplikacja sterująca po otrzymaniu zapytania sprawdza czy zewnętrzny identyfikator przesłany przez platformę wykonującą znajduję się już w bazie danych, jeśli tak to pobiera jego dane oraz zwraca je. W przeciwnym razie aplikacja sterująca dzięki Mainflux CLI loguje się jako administrator, tworzy nową rzecz oraz 2 kanały, po czym przypisuje je do stworzonej rzeczy oraz do rzeczy serwera. Rzecz serwera jest to utworzony obiekt przy starcie środowiska testowego, który ma przypisane do siebie wszystkie kanały. 
Kolejnym zadaniem aplikacji sterującej jest przesyłanie wiadomości z panelu użytkownika na platformę wykonującą oraz odbieranie wiadomości od platformy wykonującej. Wysyłanie wiadomości jest stosunkowo łatwe. Wystarczy, że aplikacja sterująca wyśle payload na odpowiedni kanał, który nasłuchuje w tym samym czasie. Z kolei odbieranie wiadomości jest bardziej skomplikowane, aby odebrać wiadomość aplikacja sterująca musi nasłuchiwać na kanale. Ze względu na to, że wiele platform wykonujących może w tym samym momencie wysyłać wiadomości, aplikacja powinna jednocześnie nasłuchiwać na wszystkich kanałach. Aplikacja sterująca dodaje kanały które znajdują się w bazie danych. Oznacza to, że w momencie gdy nowa platforma wykonująca przechodzi proces autoryzacji, lista nasłuchujących kanałów musi zostać automatycznie odświeżona.
\begin{figure}[H]
    \centering
    \fbox{\includegraphics[width=0.95\textwidth]{kp09}}
    \caption{Zrzut ekranu - interfejs pentestera}
    \label{fig:dahsboard}
\end{figure}
Aplikacja sterująca oferuje rest api, które udostępnia metody potrzebne do stworzenia Dashboardu. Dashboard jest to łatwy w odczycie interfejs, który pośredniczy miedzy pentesterem a aplikacją sterującą. 
Jednym z celów dashboardu jest wyświetlenie wiadomości przesłanych przez platformę wykonującą. Pozwala to pentesterowi na przeglądanie wiadomości. 
Interfejs pentestera wyświetla również aktywne platformy wykonujące. Aplikacja sterująca udostępnia (wykorzystując rest api) listę aktywnych urządzeń. Lista jest uaktualniana co 5 sekund. % Dane na ich temat, znajdują się na liście aktywnych urządzeń i są umieczszone w aplikacji sterującej.
Uaktualnianie polega na tym, że platforma wykonująca co 2s zgłasza aktywność, jeśli serwer nie otrzyma wiadomości od platformy przez więcej niż 4s aktualny wynik zostaje usunięty. 
Dashboard umożliwia wysłanie ładunku na wskazaną platformę lub do wszystkich aktywnych urządzeń. %Serwer pozwala na wysłanie wiadomości na wskazaną platformę lub do wszystkich aktywnych urządzeń. 
Aby pentester mógł wysłać payload na pojedynczą platformę, musi wpisać zewnętrzny identyfikator urządzenia. 
Serwer, który otrzyma zapytanie z takim identyfikatorem sprawdza, czy wskazane urządzenie istnieje, jeśli tak to pobiera kanał, na którym nasłuchuje oraz wysyła wiadomość. 
A jeśli pentester chce wysłać ładunek do wszystkich platform wykonujących, to musi w polu przeznaczonym na identyfikator wpisać słowo "All". 
Serwer w tym przypadku bierze listę aktywnych urządzeń pobiera kanały oraz wysyła wiadomości. 
Odpowiedź pentester będzie mógł przeczytać na liście przesłanych wiadomości.
Opisane ST zostało wykorzystane do zapewnienia pentesterowi stałego dostępu do platform wykonujących oraz zdalnego wykonywania testów. 
Sposób użycia ST został przedstawiony w scenariuszach \textit{Podszywanie pod HID}, \textit{Pharming} i \textit{Mitm} (rozdziały~\ref{sce:klawiatura}, \ref{sce:phar} i~\ref{sce:mitm}).